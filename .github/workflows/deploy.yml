name: Express Deploy CI/CD (v1.2)


env:
  IMAGE_TAG: 1.0.0

on:
  push:
    branches:
      - feat/ci-cd # CI-CD 구축 때만 해당 브랜치 바로 docker에 반영
  pull_request:
    branches:
        - develop

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2 # 깃허브 액션이 코드가져옴
      - name: Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_TOKEN}}

      - name: Express Image Build and Push
        run: |
          docker build -t wonseoop/not-me-fe:1.0.0 . --push

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Set up SSH    # 1. SSH 설정
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
      - name: Deploy to EC2 # 2. EC2에 접속해서 배포 스크립트 실행
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash -s' <<EOF
          set -e
          cd /home/${{secrets.SERVER_USER}}/project/docker/fe
          docker compose down
          docker compose up -d
          EOF


    